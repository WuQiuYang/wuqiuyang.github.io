"use strict";(self.webpackChunk_ohkit_site=self.webpackChunk_ohkit_site||[]).push([[64],{"./src/utils/packages/auto-reporter/src/index.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{BeforeUploadConfirm:()=>BeforeUploadConfirm,Default:()=>Default,ReportPipe:()=>ReportPipe,__namedExportsOrder:()=>__namedExportsOrder,default:()=>index_stories});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),index_es=__webpack_require__("./src/utils/packages/react-helper/dist/index.es.js"),i=function(){var i=this;this.waitList=[],this.promising=void 0,this.promiseCallbackMap=new WeakMap,this.run=function(){if(!i.promising){var n=i.waitList.shift();if(n){var a;i.promising=n();var t=0===i.waitList.length,s=i.promiseCallbackMap.get(n),r=function(){i.promising=void 0,i.run()};null!=(a=i.promising)&&a.finally?i.promising.then(function(i){null==s||s({task:n,isEnd:t,res:i})}).finally(r):(null==s||s({task:n,isEnd:t,res:i.promising}),r())}else Object.values(i.promiseCallbackMap).forEach(function(i){i({task:n,isEnd:!0})})}},this.add=function(n,a){i.waitList.push(n);var t=a||{},s=t.fireImmediately,r=void 0===s||s,e=t.returnWaitAll,l=void 0!==e&&e;return new Promise(function(a){i.promiseCallbackMap.set(n,function(t){var s=t.task,r=t.res;l?t.isEnd&&(i.promiseCallbackMap.delete(n),a(r)):n===s&&(i.promiseCallbackMap.delete(n),a(r))}),r&&i.run()})},this.start=function(){i.run()}};class AutoReporter{start(){this.timer||(this.timer=setTimeout(()=>{this.reportAndReset()},this.duration),this.triggerFlushBeforeUnload&&this.addBeforeUnloadListener())}reportAndReset(){var _this_onReport;const ret=this.reportPipe?this.requestPipe.add(()=>{var _this_onReport;return null===(_this_onReport=this.onReport)||void 0===_this_onReport?void 0:_this_onReport.call(this)}):null===(_this_onReport=this.onReport)||void 0===_this_onReport?void 0:_this_onReport.call(this);return this.reset(),ret}get pending(){return this.times>0}updateConfig(props){const{maxTimes,duration,triggerFlushBeforeUnload,reportPipe,beforeUploadConfirm,onReport}=props||{},validConfig={maxTimes,duration,triggerFlushBeforeUnload,reportPipe,beforeUploadConfirm,onReport};for(const key in validConfig){const val=validConfig[key];void 0!==val&&Object.assign(this,{[key]:val})}}register(reporter){this.onReport=reporter}reset(){this.times&&(this.times=0,this.removeBeforeUnloadListener()),this.timer&&(clearTimeout(this.timer),this.timer=null)}cancel(){this.reset()}change(){this.times++,this.start(),this.times>=this.maxTimes&&this.reportAndReset()}flush(){return!this.times||this.reportAndReset()}addBeforeUnloadListener(){this.hasBeforeUnloadListener||(window.addEventListener("beforeunload",this.handleBeforeUnload),this.hasBeforeUnloadListener=!0)}removeBeforeUnloadListener(){window.removeEventListener("beforeunload",this.handleBeforeUnload),this.hasBeforeUnloadListener=!1}constructor(props){this.beforeUploadConfirm=!1,this.maxTimes=20,this.duration=3e4,this.triggerFlushBeforeUnload=!0,this.reportPipe=!1,this.hasBeforeUnloadListener=!1,this.times=0,this.timer=null,this.requestPipe=new i,this.handleBeforeUnload=ev=>{this.times&&this.beforeUploadConfirm&&(ev.preventDefault(),(ev||window.event).returnValue=!0),this.flush()},this.updateConfig(props)}}const AutoReporterDemo=props=>{const{duration=5e3,maxTimes=5,beforeUploadConfirm,reportPipe}=props,[count,setCount]=(0,react.useState)(0),[reportTimes,setReportTimes]=(0,react.useState)(0),[runtime]=(0,index_es.EV)({autoReporter:new AutoReporter({onReport:async()=>{reportPipe&&await new Promise(resolve=>setTimeout(resolve,2e3)),setReportTimes(++runtime.reportTimes),setCount(0)},duration,maxTimes,beforeUploadConfirm}),reportTimes},["reportTimes"]);return(0,react.useEffect)(()=>{runtime.autoReporter.updateConfig({duration,maxTimes,beforeUploadConfirm})},[duration,maxTimes,beforeUploadConfirm]),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsxs)("h1",{children:["change ",maxTimes,"次或者change后延迟",duration,"毫秒会触发report事件"]}),beforeUploadConfirm&&(0,jsx_runtime.jsx)("h2",{children:"change后立即关闭当前页面试试"}),reportPipe&&(0,jsx_runtime.jsx)("h2",{children:"可以快速点击change和flush，感受report的串行"}),(0,jsx_runtime.jsx)("p",{children:(0,jsx_runtime.jsxs)("b",{children:["trigger report times: ",reportTimes]})}),(0,jsx_runtime.jsx)("p",{children:(0,jsx_runtime.jsxs)("b",{children:["change times: ",count]})}),(0,jsx_runtime.jsxs)("p",{children:[(0,jsx_runtime.jsx)("button",{onClick:()=>{setCount(count+1),runtime.autoReporter.change()},children:"change"}),(0,jsx_runtime.jsx)("button",{onClick:()=>{setCount(0),runtime.autoReporter.reset()},children:"reset"}),(0,jsx_runtime.jsx)("button",{onClick:()=>{runtime.autoReporter.flush()},children:"flush"})]})]})},index_stories={component:AutoReporterDemo,tags:["autodocs"]},Default={args:{}},BeforeUploadConfirm={args:{maxTimes:3,duration:3e3,beforeUploadConfirm:!0}},ReportPipe={args:{maxTimes:3,duration:3e3,reportPipe:!0}},__namedExportsOrder=["Default","BeforeUploadConfirm","ReportPipe"];Default.parameters={...Default.parameters,docs:{...Default.parameters?.docs,source:{originalSource:"{\n  args: {\n    // duration: 3000,\n    // maxTimes: 3,\n  }\n}",...Default.parameters?.docs?.source}}},BeforeUploadConfirm.parameters={...BeforeUploadConfirm.parameters,docs:{...BeforeUploadConfirm.parameters?.docs,source:{originalSource:"{\n  args: {\n    maxTimes: 3,\n    duration: 3000,\n    beforeUploadConfirm: true\n  }\n}",...BeforeUploadConfirm.parameters?.docs?.source}}},ReportPipe.parameters={...ReportPipe.parameters,docs:{...ReportPipe.parameters?.docs,source:{originalSource:"{\n  args: {\n    maxTimes: 3,\n    duration: 3000,\n    reportPipe: true\n  }\n}",...ReportPipe.parameters?.docs?.source}}};try{AutoReporterDemo.displayName="AutoReporterDemo",AutoReporterDemo.__docgenInfo={description:"",displayName:"AutoReporterDemo",props:{beforeUploadConfirm:{defaultValue:{value:"false"},description:"关闭页面时需要提示用户吗？",name:"beforeUploadConfirm",required:!1,type:{name:"boolean"}},maxTimes:{defaultValue:{value:"20"},description:"change事件触发次数，达到该次数后触发上报",name:"maxTimes",required:!1,type:{name:"number"}},duration:{defaultValue:{value:"30000 (30 * 1000)"},description:"change事件后，等待多少毫秒（ms）后触发上报",name:"duration",required:!1,type:{name:"number"}},triggerFlushBeforeUnload:{defaultValue:{value:"true"},description:"是否需要监听beforeunload事件 页面销毁前触发上报",name:"triggerFlushBeforeUnload",required:!1,type:{name:"boolean"}},reportPipe:{defaultValue:{value:"false"},description:"onReport 若为 Promise，是否需要串行上报",name:"reportPipe",required:!1,type:{name:"boolean"}},onReport:{defaultValue:null,description:"触发自动上报回调",name:"onReport",required:!1,type:{name:"Reporter"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/utils/packages/auto-reporter/src/index.stories.tsx#AutoReporterDemo"]={docgenInfo:AutoReporterDemo.__docgenInfo,name:"AutoReporterDemo",path:"src/utils/packages/auto-reporter/src/index.stories.tsx#AutoReporterDemo"})}catch(__react_docgen_typescript_loader_error){}},"./src/utils/packages/platform/dist/index.es.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{M:()=>n,nr:()=>o});var n="undefined"!=typeof document;function r(r,t){return n?r():null==t?void 0:t()}r(function(){return globalThis||window||self||__webpack_require__.g},function(){return globalThis||__webpack_require__.g});var i=r(function(){return/(chrome)/i.test(window.navigator.userAgent)},function(){return!1}),o=r(function(){return/(safari)/i.test(window.navigator.userAgent)&&!i},function(){return!1});r(function(){return/(firefox)/i.test(window.navigator.userAgent)},function(){return!1})},"./src/utils/packages/react-helper/dist/index.es.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{EV:()=>a,FH:()=>f,Ky:()=>p,bl:()=>u});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),_barrel_optimize_names_pick_lodash_es__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/lodash-es/pick.js"),_ohkit_platform__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/utils/packages/platform/dist/index.es.js");function u(n,o){"function"==typeof n?n(o):n&&n.hasOwnProperty("current")&&Object.assign(n,{current:o})}function a(o,t){var r=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(o),e=function(n){void 0===n&&(n={}),n&&"object"==typeof n&&Object.assign(r.current,n)};return t&&e((0,_barrel_optimize_names_pick_lodash_es__WEBPACK_IMPORTED_MODULE_2__.A)(o,t)),[r.current,e]}var f=function(n,r){_ohkit_platform__WEBPACK_IMPORTED_MODULE_1__.M?(0,react__WEBPACK_IMPORTED_MODULE_0__.useLayoutEffect)(n,r):(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)(n,r)};function p(n,o,t){var i=n[o],c="function"==typeof i,u=t||{},p=u.onChange,m=u.defaultValue,v=void 0===m?i:m,s=u.compare,d=void 0===s?function(n,o){return n===o}:s,h=(0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(function(){return void 0!==i?i:v}),l=h[0],g=h[1],C=a({onChange:p,compare:d,inner:l,isFuncState:c},["compare","onChange","inner","isFuncState"])[0],y=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)(function(n,o){void 0===o&&(o=!0),null!=C.compare&&C.compare(C.inner,n)||(g(C.isFuncState?function(){return n}:n),o&&(null==C.onChange||C.onChange(n)))},[C]);return f(function(){var n=i;void 0===i&&void 0!==v&&(n=v),y(n,!1)},[v,i]),[l,y]}}}]);